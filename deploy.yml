---
- name: Deploying Book Bot code
  hosts: all
  user: root

  tasks:
  - name: Pull Book Bot repo updates
    become: yes
    become_user: root
    git:
      repo: "https://github.com/jansendotsh/discord-book-bot.git"
      dest: "/data/book-bot"
      version: master
      update: yes

  - name: Stop Book Bot daemon
    become: yes
    become_user: root
    systemd:
      name: bookbot
      state: stopped

  - name: Delete Docker image
    become: yes
    become_user: root
    docker_image:
      name: book-bot
      tag: "0.1"
      state: absent

  - name: Building Docker image
    become: yes
    become_user: root
    docker_image:
      name: book-bot
      tag: "0.1"
      build:
        path: /data/book-bot
        pull: yes
      source: build
      state: present

  - name: Start Book Bot daemon
    become: yes
    become_user: root
    systemd:
      name: bookbot
      state: started